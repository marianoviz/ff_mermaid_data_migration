---
title: "process_hon_coralnet"
author: "Mariano Viz"
date: "2024-08-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(lubridate)
library(kableExtra)
library(stringdist)
library(writexl)
library(readxl)
library(stringr)

#CoralNet
calabash <- read_csv(here("data", "raw", "coralnet", "annotations_calabash_bight_port_royal_roatan.csv"))
iriona_colon <- read_csv(here("data", "raw", "coralnet", "annotations_iriona_colon.csv"))
guanaja_pastos <- read_csv(here("data", "raw", "coralnet", "annotations_rare_guanaja_pastos_marinos.csv"))
arrecifes <- read_csv(here("data", "raw", "coralnet", "annotations_rare_arrecifes_2023.csv"))


#Site info
habitat_sites <- read_excel(here("data", "processed", "honduras", "ff2.0", "hon_ff2.0_habitat_sites_processed.xlsx"))
fish_sites <- read_excel(here("data", "processed", "honduras", "ff2.0", "hon_ff2.0_fish_sites_processed.xlsx"))

sites_info <- read_excel(here("data", "raw", "sites_honduras.xlsx"))%>%
  mutate(name = tolower(name)) %>% #All to lowercase to avoid duplicates based on using uppercase 
  mutate(name = gsub(" ", "_", name)) %>% #Change spaces to _ to avoid duplicates
  distinct(name, .keep_all = TRUE)


```




## Calabash Bight Port Royal, Roatan

```{r}

# 1. SITE

# Initialize site column
calabash$site <- NA

# Assign site based on Name content
calabash <- calabash %>%
  mutate(site = case_when(
    str_detect(Name, regex("BAJO SECO|Bajo Seco", ignore_case = TRUE)) ~ "bajo_seco",
    str_detect(Name, regex("Cayo Blanco", ignore_case = TRUE)) ~ "cayo_blanco",
    str_detect(Name, regex("NMSF1", ignore_case = TRUE)) ~ "nmsf1",
    TRUE ~ site
  )) %>%
  mutate(site = ifelse(!is.na(sitio), sitio, site)) %>%  # Override with 'sitio' if not NA
  select(-sitio)

# Check site completeness
any(is.na(calabash$site)) # No


# 2. MANAGEMENT

calabash <- calabash %>%
  mutate(management = case_when(
    str_detect(habitat, "outside ZRP") ~ "Managed Access",
    str_detect(habitat, "inside ZRP|Inside ZRP") ~ "Reserve",
    site %in% c("bajo_seco", "cayo_blanco", "nmsf1") ~ "Reserve",
    TRUE ~ NA_character_
  ))

# Check management completeness
any(is.na(calabash$management)) # No


# 3. DATE

calabash <- calabash %>%
  rename(date = Date) %>%
  mutate(date = ifelse(is.na(date), "08/03/2021", format(as.Date(date), "%d/%m/%Y")))


# 4. QUADRAT & TRANSECT

calabash <- calabash %>%
  rename(transect = transepto)

# Assign quadrats — one per unique image
calabash <- calabash %>%
  group_by(site, transect) %>%
  mutate(quadrat = dense_rank(Name)) %>%
  ungroup()

# Fix: use backup column before overwriting transect
calabash <- calabash %>%
  mutate(transect_original = transect) %>%
  mutate(transect = case_when(
    grepl("BAJO SECO - T1", Name) ~ 1,
    grepl("Santa Fe_Bajo Seco_T2", Name) ~ 2,
    grepl("Santa Fe_Bajo Seco_T3", Name) ~ 3,
    grepl("Santa Fe_Bajo Seco_T4", Name) ~ 4,
    grepl("Santa Fe_Bajo Seco_T5", Name) ~ 5,
    grepl("Santa Fe_Cayo Blanco_T1", Name) ~ 1,
    grepl("Santa Fe_Cayo Blanco_T2", Name) ~ 2,
    grepl("Santa Fe_Cayo Blanco_T3", Name) ~ 3,
    grepl("Santa Fe_Cayo Blanco_T4", Name) ~ 4,
    grepl("Santa Fe_Cayo Blanco_T5", Name) ~ 5,
    grepl("Santa Fe_NMSF1_T1", Name) ~ 1,
    grepl("Santa Fe_NMSF1_T2", Name) ~ 2,
    grepl("CBPR22.1", Name) ~ 1,
    grepl("CBPR22.2", Name) ~ 2,
    TRUE ~ as.numeric(transect_original)
  )) %>%
  select(-transect_original)


# 5. LATITUDE & LONGITUDE

# Standardize lat/lon column names
calabash <- calabash %>%
  rename(latitude = Latitude, longitude = Longitude)

# Create calabash_sites summary
calabash_sites <- calabash %>%
  mutate(site_name = NA_character_) %>%
  select(site_name, site, latitude, longitude) %>%
  rename(name = site) %>%
  mutate(
    country = "Honduras",
    reef_type = NA_character_,
    reef_zone = NA_character_,
    reef_exposure = NA_character_
  ) %>%
  distinct(name, latitude, longitude, .keep_all = TRUE)

# Join habitat_sites info based on site name
calabash_sites <- calabash_sites %>%
  left_join(
    habitat_sites %>%
      select(name, latitude, longitude, site_name, reef_type, reef_zone, reef_exposure),
    by = "name",
    suffix = c("", ".habitat")
  ) %>%
  mutate(
    latitude       = coalesce(latitude.habitat, latitude),
    longitude      = coalesce(longitude.habitat, longitude),
    site_name      = coalesce(site_name.habitat, site_name),
    reef_type      = coalesce(reef_type.habitat, reef_type),
    reef_zone      = coalesce(reef_zone.habitat, reef_zone),
    reef_exposure  = coalesce(reef_exposure.habitat, reef_exposure)
  ) %>%
  select(-ends_with(".habitat"))

# Confirm latitude is complete
any(is.na(calabash$latitude)) # Should be FALSE


# 6. VALIDATION SUMMARY

calabash %>%
  group_by(site, transect) %>%
  summarise(
    n_quadrats = n_distinct(quadrat),
    avg_points_per_quadrat = n() / n_quadrats,
    .groups = "drop"
  ) %>%
  arrange(site, transect) %>%
  print(n = Inf)

# Expect ~5–10 quadrats per transect, and ~25 points per quadrat


```


### Template MERMAID

```{r}

# 1. DEFINE CONSTANTS
methodology <- "benthic_pqt"
fixed_depth <- 8.34
points_per_quadrat <- 25

# 2. COUNT QUADRATS PER TRANSECT
quadrat_counts <- calabash %>%
  group_by(site, transect) %>%
  summarise(`Number of quadrats *` = n_distinct(quadrat), .groups = "drop") %>%
  rename(`Site *` = site, `Transect number *` = transect)

# 3. PREPARE METADATA
mermaid_metadata <- calabash %>%
  mutate(
    `Methodology *`         = methodology,
    `Sample date: Year *`   = year(dmy(date)),
    `Sample date: Month *`  = month(dmy(date)),
    `Sample date: Day *`    = day(dmy(date)),
    `Depth *`               = fixed_depth
  ) %>%
  rename(
    `Site *`                = site,
    `Management *`          = management,
    `Transect number *`     = transect,
    `Quadrat *`             = quadrat,
    `Benthic attribute *`   = Label
  )

# 4. APPLY NAME REPLACEMENTS BEFORE GROUPING
coralnet_labels <- read_excel(
  path = here("data", "raw", "Coralnet Labels.xlsx"),
  sheet = "Sheet1"
) %>%
  filter(!is.na(Code), !is.na(Name)) %>%
  distinct(Code, .keep_all = TRUE)

# Force column names to be lowercase (defensive coding)
coralnet_labels <- coralnet_labels %>%
  rename_with(tolower) %>%
  filter(!is.na(code), !is.na(name)) %>%
  distinct(code, .keep_all = TRUE)

# Now perform the merge using lowercase `name`
mermaid_metadata <- mermaid_metadata %>%
  left_join(coralnet_labels, by = c("Benthic attribute *" = "code")) %>%
  mutate(`Benthic attribute *` = coalesce(name, `Benthic attribute *`)) %>%
  select(-name)

mermaid_metadata <- mermaid_metadata %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "MAL_turf"                      = "Turf algae",
    "Paly"                         = "Palythoa",
    "Live Coral"                   = "Live Coral",                    
    "Sponge: Encrusting"           = "Encrusting sponge",
    "Mil_spp"                      = "Millepora spp.",
    "Pavement"                     = "Reef pavement",
    "Gorgonia spp."                = "Gorgonia",
    "Mont_spp"                     = "Montastraea spp.",
    "Brown Macroalgae"             = "Macroalgae",
    "Turf and sand"                = "Turf algae",
    "DS"                           = "Dead substrate",
    "Plexaura spp."                = "Plexaura",
    "AG"                           = "Agaricia",
    "Thin Soft Octocoral"          = "Soft coral",
    "Montastrea annularis"         = "Orbicella annularis",
    "Sponge: Cliona"               = "Cliona",
    "Pseudopterogorgia bipinnata" = "Pseudopterogorgia",
    "Unknown macroalgae"           = "Macroalgae",
    "Red algae, unidentified encrusting" = "Crustose red algae",
    "Sand / Rubble"                = "Rubble",
    "Turf on dead massive coral"   = "Turf algae",
    "Millepora dead"               = "Millepora",
    "Green algae, unidentified"    = "Green algae",
    "Recent Dead Coral"            = "Dead coral",
    "Sponges: Vase"                = "Sponge",
    "Rope sponge"                  = "Sponge",
    "Other invertebrate"           = "Other invertebrates",
    "Tube or Rod Sponge"           = "Sponge",
    "Pseudoplexaura spp."          = "Pseudoplexaura",
    "Millepora_encrusting"         = "Millepora"
  )) %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Live Coral"                    = "Hard coral",
    "Encrusting sponge"             = "Sponge",
    "Millepora spp."                = "Millepora",
    "Reef pavement"                 = "Bare substrate",
    "Montastraea spp."              = "Montastraea",
    "Dead substrate"                = "Bare substrate",
    "Pseudoterogorgia bipinnata"    = "Pseudopterogorgia",
    "Crustose red algae"            = "Crustose coralline algae"
  ))

# 5. COUNT POINTS PER TRANSECT × QUADRAT × BENTHIC ATTRIBUTE
point_counts <- mermaid_metadata %>%
  group_by(`Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`) %>%
  summarise(`Number of points *` = n(), .groups = "drop")

# 6. JOIN BACK METADATA (one row per group)
mermaid_df <- point_counts %>%
  left_join(
    mermaid_metadata %>% distinct(
      `Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`,
      `Methodology *`, `Management *`,
      `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`, `Depth *`
    ),
    by = c("Site *", "Transect number *", "Quadrat *", "Benthic attribute *")
  )

# 7. ADD CONSTANT FIELDS
mermaid_df <- mermaid_df %>%
  mutate(
    `Quadrat size *`              = 1,
    `Transect length surveyed *`  = 50,
    `Number of points per quadrat *` = points_per_quadrat
  ) %>%
  left_join(quadrat_counts, by = c("Site *", "Transect number *"))

# 8. FINAL COLUMN ORDER
selected_coralnet_calabash_habitat_hon <- mermaid_df %>%
  select(
    `Methodology *`, `Site *`, `Management *`,
    `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`,
    `Depth *`, `Transect number *`, `Benthic attribute *`,
    `Quadrat size *`, `Transect length surveyed *`, `Quadrat *`,
    `Number of points *`, `Number of points per quadrat *`, `Number of quadrats *`
  )





# 6. EXPORT
# Excel Output:
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_calabash_habitat_processed.xlsx")
# write_xlsx(selected_coralnet_calabash_habitat_hon, file_path)



# Export
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_calabash_habitat_sites_processed.xlsx")
# write_xlsx(calabash_sites, file_path)


```






## Iriona, Colon


```{r}
# 1. SITE
iriona_colon <- iriona_colon %>%
  rename(site = Sitio) %>%
  mutate(site = tolower(site)) %>%
  mutate(site = gsub(" ", "_", site))

# 2. MANAGEMENT
iriona_colon <- iriona_colon %>%
  rename(management = Zona) %>%
  mutate(management = "Managed Access")

# 3. DATE
iriona_colon <- iriona_colon %>%
  rename(date = Date) %>%
  mutate(date = ifelse(is.na(date), "08/03/2021", format(as.Date(date), "%d/%m/%Y")))

# 4. QUADRAT & TRANSECT
iriona_colon <- iriona_colon %>%
  # Extract transect number using regex like "T1", "T2", etc.
  mutate(transect = as.numeric(str_extract(Name, "(?<=-T)\\d+"))) %>%

  # Group by site + transect, and rank image filenames to assign quadrat
  group_by(site, transect) %>%
  mutate(quadrat = dense_rank(Name)) %>%
  ungroup()

# 5. LATITUDE & LONGITUDE
iriona_colon <- iriona_colon %>%
  rename(latitude = Latitude, longitude = Longitude) %>%
  mutate(
    # Fix coordinate issues
    latitude = if_else(latitude == "16P 669483", 15.8778, as.numeric(latitude)),
    longitude = if_else(longitude == 1756059, -85.417053, as.numeric(longitude)),
    
    # Fix site name
    site = if_else(site == "mil_2", "mil2", site)
  )

# Site info for site-level metadata
# Create calabash_sites summary
iriona_colon_sites <- iriona_colon %>%
  mutate(site_name = NA_character_) %>%
  select(site_name, site, latitude, longitude) %>%
  rename(name = site) %>%
  mutate(
    country = "Honduras",
    reef_type = NA_character_,
    reef_zone = NA_character_,
    reef_exposure = NA_character_
  ) %>%
  distinct(name, latitude, longitude, .keep_all = TRUE)

# Join habitat_sites info based on site name
iriona_colon_sites <- iriona_colon_sites %>%
  left_join(
    habitat_sites %>%
      select(name, latitude, longitude, site_name, reef_type, reef_zone, reef_exposure),
    by = "name",
    suffix = c("", ".habitat")
  ) %>%
  mutate(
    latitude       = coalesce(latitude.habitat, latitude),
    longitude      = coalesce(longitude.habitat, longitude),
    site_name      = coalesce(site_name.habitat, site_name),
    reef_type      = coalesce(reef_type.habitat, reef_type),
    reef_zone      = coalesce(reef_zone.habitat, reef_zone),
    reef_exposure  = coalesce(reef_exposure.habitat, reef_exposure)
  ) %>%
  select(-ends_with(".habitat"))

# Confirm latitude is complete
any(is.na(iriona_colon_sites$latitude)) # Should be FALSE


# 6. VALIDATION SUMMARY
iriona_colon %>%
  group_by(site, transect) %>%
  summarise(
    n_quadrats = n_distinct(quadrat),
    avg_points_per_quadrat = n() / n_quadrats,
    .groups = "drop"
  ) %>%
  arrange(site, transect) %>%
  print(n = Inf)




```


### Template MERMAID

```{r}

# 1. DEFINE CONSTANTS
methodology <- "benthic_pqt"
fixed_depth <- 8.34
points_per_quadrat <- 10

# 2. COUNT QUADRATS PER TRANSECT
quadrat_counts <- iriona_colon %>%
  group_by(site, transect) %>%
  summarise(`Number of quadrats *` = n_distinct(quadrat), .groups = "drop") %>%
  rename(`Site *` = site, `Transect number *` = transect)

# 3. PREPARE METADATA
mermaid_metadata <- iriona_colon %>%
  mutate(
    `Methodology *`         = methodology,
    `Sample date: Year *`   = year(dmy(date)),
    `Sample date: Month *`  = month(dmy(date)),
    `Sample date: Day *`    = day(dmy(date)),
    `Depth *`               = fixed_depth
  ) %>%
  rename(
    `Site *`                = site,
    `Management *`          = management,
    `Transect number *`     = transect,
    `Quadrat *`             = quadrat,
    `Benthic attribute *`   = Label
  )

# 4. APPLY NAME REPLACEMENTS BEFORE GROUPING
coralnet_labels <- read_excel(
  path = here("data", "raw", "Coralnet Labels.xlsx"),
  sheet = "Sheet1"
) %>%
  filter(!is.na(Code), !is.na(Name)) %>%
  distinct(Code, .keep_all = TRUE)

# Force column names to be lowercase (defensive coding)
coralnet_labels <- coralnet_labels %>%
  rename_with(tolower) %>%
  filter(!is.na(code), !is.na(name)) %>%
  distinct(code, .keep_all = TRUE)

# Now perform the merge using lowercase `name`
mermaid_metadata <- mermaid_metadata %>%
  left_join(coralnet_labels, by = c("Benthic attribute *" = "code")) %>%
  mutate(`Benthic attribute *` = coalesce(name, `Benthic attribute *`)) %>%
  select(-name)

mermaid_metadata <- mermaid_metadata %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Dictyota with Sediment"        = "Macroalgae",
    "Sediment"                      = "Sand",
    "Unidentified orange sponge"    = "Sponge",
    "Tube or Rod Sponge"            = "Sponge",
    "Turf with sediment"            = "Turf algae",
    "Unknown Sponge/Tunicate"       = "Sponge",
    "AG"                             = "Agaricia",
    "Gorgonia spp."                 = "Gorgonia",
    "Unknown macroalgae"            = "Macroalgae",
    "Dict"                          = "Silt",
    "Pavement"                      = "Reef pavement",
    "Plexaurella spp."              = "Plexaura",
    "Eunicea spp."                  = "Eunicea",
    "Unidentified Octocoral"        = "Soft coral",
    "Encrusting sponge"             = "Encrusting sponge",
    "Red Macroalgae"                = "Macroalgae",
    "Brown Macroalgae"              = "Macroalgae",
    "Unknown Invertebrate"          = "Other invertebrates",
    "Turf and sand"                 = "Turf algae",
    "Calcareous algae"              = "Macroalgae",
    "Sponge: Cliona"                = "Cliona",
    "Turf growing on hard substrate" = "Turf algae",
    "Sand and sediment"             = "Sand",
    "Mont_spp"                      = "Montastraea spp.",
    "Sponges: Vase"                 = "Sponge"
  )) %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Encrusting sponge"             = "Sponge",
    "Reef pavement"                 = "Bare substrate",
    "Montastraea spp."              = "Montastraea"
  ))

# 5. COUNT POINTS PER TRANSECT × QUADRAT × BENTHIC ATTRIBUTE
point_counts <- mermaid_metadata %>%
  group_by(`Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`) %>%
  summarise(`Number of points *` = n(), .groups = "drop")

# 6. JOIN BACK METADATA (one row per group)
mermaid_df <- point_counts %>%
  left_join(
    mermaid_metadata %>% distinct(
      `Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`,
      `Methodology *`, `Management *`,
      `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`, `Depth *`
    ),
    by = c("Site *", "Transect number *", "Quadrat *", "Benthic attribute *")
  )

# 7. ADD CONSTANT FIELDS
mermaid_df <- mermaid_df %>%
  mutate(
    `Quadrat size *`              = 1,
    `Transect length surveyed *`  = 50,
    `Number of points per quadrat *` = points_per_quadrat
  ) %>%
  left_join(quadrat_counts, by = c("Site *", "Transect number *"))

# 8. FINAL COLUMN ORDER
selected_coralnet_iriona_habitat_hon <- mermaid_df %>%
  select(
    `Methodology *`, `Site *`, `Management *`,
    `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`,
    `Depth *`, `Transect number *`, `Benthic attribute *`,
    `Quadrat size *`, `Transect length surveyed *`, `Quadrat *`,
    `Number of points *`, `Number of points per quadrat *`, `Number of quadrats *`
  )





# 6. EXPORT

# Excel Output:
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_iriona_habitat_processed.xlsx")
# write_xlsx(selected_coralnet_iriona_habitat_hon, file_path)
# 
# 
# 
# # Export
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_iriona_habitat_sites_processed.xlsx")
# write_xlsx(iriona_colon_sites, file_path)



```







## Guanaja, Pastos Marinos

```{r}

# 1. SITE
guanaja_pastos <- guanaja_pastos %>%
  rename(site = Site) %>%
  mutate(site = str_extract(Name, "^[A-Za-z]{4}\\d"))%>% 
  mutate(`site` = tolower(`site`)) %>% 
  mutate(`site` = gsub(" ", "_", `site`))

# 2. MANAGEMENT

# fish_data_guanaja <- read_excel(here("data", "processed", "honduras", "ff2.0", "hon_ff2.0_fish_processed.xlsx")) %>% 
#   mutate(`Site *` = tolower(`Site *`)) %>% #All to lowercase to avoid duplicates based on using uppercase 
#   mutate(`Site *` = gsub(" ", "_", `Site *`)) %>% 
#   rename(site = `Site *`) %>% 
#   distinct(site, `Management *`) %>%
#   arrange(site)


guanaja_pastos <- guanaja_pastos %>%
  mutate(management = NA) %>%
  mutate(management = case_when(
    site == "glca3" ~ "Managed Access", #EXCEPT GLCA4 THESE ARE BEST GUESSES!
    site == "glca4" ~ "Managed Access",
    site == "glcp1" ~ "Managed Access",
    site == "glip3" ~ "Reserve",
    site == "gmip2" ~ "Reserve",
    TRUE ~ NA_character_  # Keep NA for sites not listed
  ))


# 3. DATE
guanaja_pastos <- guanaja_pastos %>% 
  rename(date = Date) %>%
  mutate(date = ifelse(is.na(date), "06/06/2021", format(as.Date(date), "%d/%m/%Y")))

# 4. QUADRAT & TRANSECT
guanaja_pastos <- guanaja_pastos %>%
  rename(quadrat = Cuadrant) %>%
  rename(transect = Transect)

# Populate 'transect' by extracting the number that follows 'T' in the 'Name' column
guanaja_pastos <- guanaja_pastos %>%
  # Remove potential extra spaces
  mutate(Name = str_trim(Name)) %>%
  # Extract the number that follows 'T' and assign it to transect
  mutate(transect = as.numeric(str_extract(Name, "T\\s*(\\d+)")))

guanaja_pastos <- guanaja_pastos %>%
  mutate(transect_test = str_extract(Name, "T\\d+"))
guanaja_pastos <- guanaja_pastos %>%
  mutate(transect = as.numeric(gsub("T", "", transect_test)))%>%
  select(-transect_test)

guanaja_pastos <- guanaja_pastos %>%
  group_by(site, transect) %>%
  mutate(quadrat = as.numeric(factor(Name))) %>%
  ungroup()


# 5. LATITUDE & LONGITUDE
guanaja_pastos <- guanaja_pastos %>%
  # Remove the old 'Latitude' and 'Longitude' columns
  select(-Latitude, -Longitude) %>%
  # Join with 'sites_info' based on matching 'site' in guanaja_pastos and 'name' in sites_info
  left_join(
    sites_info %>% select(name, latitude, longitude),
    by = c("site" = "name")
  )

# Site info for site-level metadata
# Create calabash_sites summary
guanaja_pastos_sites <- guanaja_pastos %>%
  mutate(site_name = "Guanaja") %>%
  select(site_name, site, latitude, longitude) %>%
  rename(name = site) %>%
  mutate(
    country = "Honduras",
    reef_type = "atoll",
    reef_zone = "pinnacle",
    reef_exposure = "exposed"
  ) %>%
  distinct(name, latitude, longitude, .keep_all = TRUE)

# Join habitat_sites info based on site name
guanaja_pastos_sites <- guanaja_pastos_sites %>%
  left_join(
    habitat_sites %>%
      select(name, latitude, longitude, site_name, reef_type, reef_zone, reef_exposure),
    by = "name",
    suffix = c("", ".habitat")
  ) %>%
  mutate(
    latitude       = coalesce(latitude.habitat, latitude),
    longitude      = coalesce(longitude.habitat, longitude),
    site_name      = coalesce(site_name.habitat, site_name),
    reef_type      = coalesce(reef_type.habitat, reef_type),
    reef_zone      = coalesce(reef_zone.habitat, reef_zone),
    reef_exposure  = coalesce(reef_exposure.habitat, reef_exposure)
  ) %>%
  select(-ends_with(".habitat"))

# 6. VALIDATION SUMMARY
guanaja_pastos %>%
  group_by(site, transect) %>%
  summarise(
    n_quadrats = n_distinct(quadrat),
    avg_points_per_quadrat = n() / n_quadrats,
    .groups = "drop"
  ) %>%
  arrange(site, transect) %>%
  print(n = Inf)


```


### Template MERMAID

```{r}

# 1. DEFINE CONSTANTS
methodology <- "benthic_pqt"
fixed_depth <- 8.34
points_per_quadrat <- 10

# 2. COUNT QUADRATS PER TRANSECT
quadrat_counts <- guanaja_pastos %>%
  group_by(site, transect) %>%
  summarise(`Number of quadrats *` = n_distinct(quadrat), .groups = "drop") %>%
  rename(`Site *` = site, `Transect number *` = transect)

# 3. PREPARE METADATA
mermaid_metadata <- guanaja_pastos %>%
  mutate(
    `Methodology *`         = methodology,
    `Sample date: Year *`   = year(dmy(date)),
    `Sample date: Month *`  = month(dmy(date)),
    `Sample date: Day *`    = day(dmy(date)),
    `Depth *`               = fixed_depth
  ) %>%
  rename(
    `Site *`                = site,
    `Management *`          = management,
    `Transect number *`     = transect,
    `Quadrat *`             = quadrat,
    `Benthic attribute *`   = Label
  )

# 4. APPLY NAME REPLACEMENTS BEFORE GROUPING
coralnet_labels <- read_excel(
  path = here("data", "raw", "Coralnet Labels.xlsx"),
  sheet = "Sheet1"
) %>%
  filter(!is.na(Code), !is.na(Name)) %>%
  distinct(Code, .keep_all = TRUE)

# Force column names to be lowercase (defensive coding)
coralnet_labels <- coralnet_labels %>%
  rename_with(tolower) %>%
  filter(!is.na(code), !is.na(name)) %>%
  distinct(code, .keep_all = TRUE)

# Now perform the merge using lowercase `name`
mermaid_metadata <- mermaid_metadata %>%
  left_join(coralnet_labels, by = c("Benthic attribute *" = "code")) %>%
  mutate(`Benthic attribute *` = coalesce(name, `Benthic attribute *`)) %>%
  select(-name)

mermaid_metadata <- mermaid_metadata %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Dictyota with Sediment"        = "Macroalgae",
    "Sediment"                      = "Sand",
    "Unidentified orange sponge"    = "Sponge",
    "Tube or Rod Sponge"            = "Sponge",
    "Turf with sediment"            = "Turf algae",
    "Unknown Sponge/Tunicate"       = "Sponge",
    "AG"                             = "Agaricia",
    "Gorgonia spp."                 = "Gorgonia",
    "Unknown macroalgae"            = "Macroalgae",
    "Dict"                          = "Silt",
    "Pavement"                      = "Reef pavement",
    "Plexaurella spp."              = "Plexaura",
    "Eunicea spp."                  = "Eunicea",
    "Unidentified Octocoral"        = "Soft coral",
    "Encrusting sponge"             = "Encrusting sponge",
    "Red Macroalgae"                = "Macroalgae",
    "Brown Macroalgae"              = "Macroalgae",
    "Unknown Invertebrate"          = "Other invertebrates",
    "Turf and sand"                 = "Turf algae",
    "Calcareous algae"              = "Macroalgae",
    "Sponge: Cliona"                = "Cliona",
    "Turf growing on hard substrate" = "Turf algae",
    "Sand and sediment"             = "Sand",
    "Mont_spp"                      = "Montastraea spp.",
    "Sponges: Vase"                 = "Sponge"
  )) %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Encrusting sponge"             = "Sponge",
    "Reef pavement"                 = "Bare substrate",
    "Montastraea spp."              = "Montastraea"
  ))%>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Thalassia+ sediement"             = "Thalassia testudinum",
    "Unidentified"                 = "Unknown",
    "Other invertebrate"              = "Other invertebrates",
    "Green Macroalgae"              = "Green algae",
    "Live Coral"              = "Hard coral",
    "sandy mud"              = "Sand"
  ))





# 5. COUNT POINTS PER TRANSECT × QUADRAT × BENTHIC ATTRIBUTE
point_counts <- mermaid_metadata %>%
  group_by(`Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`) %>%
  summarise(`Number of points *` = n(), .groups = "drop")

# 6. JOIN BACK METADATA (one row per group)
mermaid_df <- point_counts %>%
  left_join(
    mermaid_metadata %>% distinct(
      `Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`,
      `Methodology *`, `Management *`,
      `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`, `Depth *`
    ),
    by = c("Site *", "Transect number *", "Quadrat *", "Benthic attribute *")
  )

# 7. ADD CONSTANT FIELDS
mermaid_df <- mermaid_df %>%
  mutate(
    `Quadrat size *`              = 1,
    `Transect length surveyed *`  = 50,
    `Number of points per quadrat *` = points_per_quadrat
  ) %>%
  left_join(quadrat_counts, by = c("Site *", "Transect number *"))

# 8. FINAL COLUMN ORDER
selected_guanaja_pastos_habitat_hon <- mermaid_df %>%
  select(
    `Methodology *`, `Site *`, `Management *`,
    `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`,
    `Depth *`, `Transect number *`, `Benthic attribute *`,
    `Quadrat size *`, `Transect length surveyed *`, `Quadrat *`,
    `Number of points *`, `Number of points per quadrat *`, `Number of quadrats *`
  )





# 6. EXPORT

# Excel Output:
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_guanaja_habitat_processed.xlsx")
# write_xlsx(selected_guanaja_pastos_habitat_hon, file_path)
# 
# 
# 
# # Export
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_guanaja_habitat_sites_processed.xlsx")
# write_xlsx(guanaja_pastos_sites, file_path)



```







## Arrecifes 2023

```{r}
## SITE
# Remove T3RFCA (just 1 JPG)
arrecifes <- subset(arrecifes, !grepl("^T3RFCA", Name))

# Define the prefixes to check for copying into the site column
prefixes <- c('RFCA1','RFCA2','RFCA3', 'RFIA1', 'RFIA2', 'RFIP1', 'RFIP2', 'RMCA1', 'RMCP1', 'RMIA1', 'RMIA2', 'RMIP1')

# Create the 'site' column
arrecifes$site <- sapply(arrecifes$Name, function(name) {
  # Check if the name starts with any of the defined prefixes
  for (prefix in prefixes) {
    if (startsWith(name, prefix)) {
      return(prefix)
    }
  }
  # Otherwise, extract substring before the first '-'
  if (grepl("-", name)) {
    return(strsplit(name, "-")[[1]][1])
  }
  return(NA)
})

arrecifes <- subset(arrecifes, !is.na(site))

unique(arrecifes$site)


rename_list <- c(
  "BajoCalderoncontrol" = "bajo_calderon_control",
  "BajoSecoReserve" = "bajo_seco",
  "Cayoblancoreserve" = "cayo_blanco_reserve",
  "CayoBlancoReserve" = "cayo_blanco_reserve",
  "ControlPSantaFé" = "control_santa_fe",
  "ControlPSantaFe" = "control_santa_fe",
  "GLIA3reef" = "glia3",
  "GMCA1" = "gmca1",
  "GMIA1" = "gmia1",
  "GMIA2" = "gmia2",
  "GMIA3" = "gmia3",
  "ImpactoSantaFéP1" = "impacto_santa_fe_1",
  "ImpactoSantaFéP2" = "impacto_santa_fe_2",
  "NMSF1" = "nmsf1",
  "NMSF" = "nmsf",
  "RFCA1" = "rfca1",
  "RFCA2" = "rfca2",
  "RFCA3" ="rfca3",
  "RFIA1" = "rfia1",
  "RFIA2" = "rfia2",
  "RFIP1" = "rfip1",
  "RFIP2" = "rfip2",
  "RMCA1" = "rmca1",
  "RMCP1" = "rmcp1",
  "RMIA1" = "rmia1",
  "RMIA2" = "rmia2",
  "RMIP1" = "rmip1"
)

# Use mutate and recode to rename the 'site' column
arrecifes <- arrecifes %>%
  mutate(site = recode(site, !!!rename_list))
arrecifes <- arrecifes %>%
  mutate(`site` = tolower(`site`)) %>% 
  mutate(`site` = gsub(" ", "_", `site`))


# 2. MANAGEMENT
fish_data <- read_excel(here("data", "processed", "honduras", "ff2.0", "hon_ff2.0_fish_processed.xlsx")) %>% 
  mutate(`Site *` = tolower(`Site *`)) %>% #All to lowercase to avoid duplicates based on using uppercase
  mutate(`Site *` = gsub(" ", "_", `Site *`)) %>%
  rename(site = `Site *`) %>%
  distinct(site, `Management *`) %>%
  arrange(site)
habitat_data <- read_excel(here("data", "processed", "honduras", "ff2.0", "hon_ff2.0_habitat_processed.xlsx")) %>% 
  mutate(`Site *` = tolower(`Site *`)) %>% #All to lowercase to avoid duplicates based on using uppercase
  mutate(`Site *` = gsub(" ", "_", `Site *`)) %>%
  rename(site = `Site *`) %>%
  distinct(site, `Management *`) %>%
  arrange(site)

arrecifes <- arrecifes %>%
  mutate(management = case_when(
    site == "bajo_calderon_control" ~ "Managed Access",
    site == "bajo_seco" ~ "Reserve",
    site == "cayo_blanco" ~ "Reserve",
    site == "cayo_blanco_reserve" ~ "Reserve",
    site == "rfca3" ~ "Managed Access",
    site == "control_santa_fe" ~ "Reserve",
    site == "glia3" ~ "Reserve",
    site == "gmca1" ~ "Managed Access",
    site == "gmia1" ~ "Reserve",
    site == "gmia2" ~ "Reserve",
    site == "gmia3" ~ "Reserve",
    site == "impacto_santa_fe_1" ~ "Reserve",
    site == "impacto_santa_fe_2" ~ "Reserve",
    site == "nmsf1" ~ "Managed Access",
    site == "nmsf" ~ "Managed Access",
    site == "rfca1" ~ "Managed Access",
    site == "rfca2" ~ "Managed Access",
    site == "rfia1" ~ "Managed Access",
    site == "rfia2" ~ "Managed Access",
    site == "rfip1" ~ "Managed Access",
    site == "rfip2" ~ "Managed Access",
    site == "rmca1" ~ "Managed Access",
    site == "rmcp1" ~ "Managed Access",
    site == "rmia1" ~ "Managed Access",
    site == "rmia2" ~ "Managed Access",
    site == "rmip1" ~ "Managed Access",
    TRUE ~ NA_character_  # Default
  ))



# 3. DATE

arrecifes <- arrecifes %>%
  rename(date = Date) %>%
  mutate(date = format(as.Date(date, format = "%Y-%m-%d"), "%d/%m/%Y"))



arrecifes <- arrecifes %>%
  mutate(date = as.Date(if_else(is.na(date), "01/06/2023", as.character(date)), format = "%d/%m/%Y"))

arrecifes <- arrecifes %>%
  mutate(date = format(as.Date(date), "%d/%m/%Y"))


unique(arrecifes$date)

# 4. QUADRAT & TRANSECT
arrecifes <- arrecifes %>%
  rename(quadrat = Cuadrant) %>%
  rename(transect = Transect) 

arrecifes <- arrecifes %>%
  mutate(transect = case_when(
    str_starts(Name, "BajoSecoReserve-T5") ~ "T5",
    str_starts(Name, "BajoSecoReserveT5") ~ "T5",
    str_starts(Name, "ControlPSantaFe-T3") ~ "T3",
    str_starts(Name, "ControlPSantaFe-T4") ~ "T4",
    str_starts(Name, "ControlPSantaFe-T5") ~ "T5",
    str_starts(Name, "NMSF1-T1") ~ "T1",
    str_starts(Name, "NMSF1-T2") ~ "T2",
    str_starts(Name, "NMSF-T2") ~ "T2",
    str_starts(Name, "RFCA2") ~ "T1",
    str_starts(Name, "RFCA3") ~ "T1",
    str_starts(Name, "RFIP2GOPR") ~ "T1",
    str_starts(Name, "RFIP2-T1") ~ "T1",
    str_starts(Name, "RFIP2-T2") ~ "T2",
    str_starts(Name, "RFIP2RFIP2T3") ~ "T3",
    str_starts(Name, "RFIP2-T4") ~ "T4",
    str_starts(Name, "RFIP2-T5") ~ "T5",
    str_starts(Name, "RMCP1T2") ~ "T2",
    str_starts(Name, "RMCP1T3") ~ "T3",
    str_starts(Name, "RMCP1T4") ~ "T4",
    str_starts(Name, "RMCP1T5") ~ "T5",
    str_starts(Name, "RMIP1T2") ~ "T2",
    str_starts(Name, "RMIP1T3") ~ "T3",
    str_starts(Name, "RMIP1T4") ~ "T4",
    str_starts(Name, "RMIP1T5") ~ "T5",
    TRUE ~ transect  # Retain the original value for other cases
  ))



# Remove the 'T' from the 'transect' column and make it numeric
arrecifes <- arrecifes %>%
 mutate(transect = as.numeric(str_remove(transect, "T")))

# Add quadrat
arrecifes <- arrecifes %>%
  group_by(site, transect) %>%
  mutate(quadrat = as.numeric(factor(Name))) %>%
  ungroup()



# 5. LATITUDE & LONGITUDE
arrecifes <- arrecifes %>%
  rename(latitude = Latitude, longitude = Longitude)
  
arrecifes_lat_long <- arrecifes %>% 
  select(site, latitude, longitude) %>%
  distinct() %>%
  group_by(site) %>%
  summarize(
    latitude_values = list(unique(latitude)),
    longitude_values = list(unique(longitude))
  )

arrecifes_sites <- arrecifes %>%
  mutate(site_name = NA_character_) %>%
  select(site_name, site, latitude, longitude) %>%
  rename(name = site) %>%
  mutate(
    country = "Honduras",
    reef_type = NA_character_,
    reef_zone = NA_character_,
    reef_exposure = NA_character_
  ) %>%
  distinct(name, latitude, longitude, .keep_all = TRUE)

# Join habitat_sites info based on site name
arrecifes_sites <- arrecifes_sites %>%
  left_join(
    habitat_sites %>%
      select(name, latitude, longitude, site_name, reef_type, reef_zone, reef_exposure),
    by = "name",
    suffix = c("", ".habitat")
  ) %>%
  mutate(
    latitude       = coalesce(latitude.habitat, latitude),
    longitude      = coalesce(longitude.habitat, longitude),
    site_name      = coalesce(site_name.habitat, site_name),
    reef_type      = coalesce(reef_type.habitat, reef_type),
    reef_zone      = coalesce(reef_zone.habitat, reef_zone),
    reef_exposure  = coalesce(reef_exposure.habitat, reef_exposure)
  ) %>%
  select(-ends_with(".habitat"))

arrecifes_sites <- arrecifes_sites %>%
  left_join(
    fish_sites %>%
      select(name, latitude, longitude, ma_name, reef_type, reef_zone, reef_exposure),
    by = "name",
    suffix = c("", ".habitat")
  ) %>%
  mutate(
    latitude       = coalesce(latitude.habitat, latitude),
    longitude      = coalesce(longitude.habitat, longitude),
    site_name      = coalesce(ma_name, site_name),
    reef_type      = coalesce(reef_type.habitat, reef_type),
    reef_zone      = coalesce(reef_zone.habitat, reef_zone),
    reef_exposure  = coalesce(reef_exposure.habitat, reef_exposure)
  ) %>%
  select(-ends_with(".habitat"), -"ma_name")


arrecifes_sites <- arrecifes_sites %>%
  mutate(
    latitude = case_when(
      name == "nmsf" ~ 15.98000,
      name == "rfca3" ~ 16.35,
      name == "rfip1" ~ 16.35,
      name == "rfip2" ~ 16.35,
      name == "rmcp1" ~ 16.35,
      name == "rmip1" ~ 16.36,
      TRUE ~ latitude
    ),
    longitude = case_when(
      name == "nmsf" ~ -86.15000,
      name == "rfca3" ~ -86.44,
      name == "rfip1" ~ -86.44,
      name == "rfip2" ~ -86.44,
      name == "rmcp1" ~ -86.44,
      name == "rmip1" ~ -86.50,
      TRUE ~ longitude
    )
  )

arrecifes_sites <- arrecifes_sites %>%
  mutate(
    site_name = case_when(
      name == "bajo_calderon_control" ~ "Trujillo",
      name == "cayo_blanco_reserve" ~ "Santa Fe",
      name == "control_santa_fe" ~ "Santa Fe",
      name == "impacto_santa_fe_1" ~ "Santa Fe",
      name == "impacto_santa_fe_2" ~ "Santa Fe",
      name == "nmsf" ~ "Santa Fe",
      name == "rfca1" ~ "Roatan",
      name == "rfca2" ~ "Roatan",
      name == "rfca3" ~ "Roatan",
      name == "rfia1" ~ "Roatan",
      name == "rfia2" ~ "Roatan",
      name == "rfip1" ~ "Roatan",
      name == "rfip2" ~ "Roatan",
      name == "rmca1" ~ "Roatan",
      name == "rmcp1" ~ "Roatan",
      name == "rmia1" ~ "Roatan",
      name == "rmia2" ~ "Roatan",
      name == "rmip1" ~ "Roatan",
      TRUE ~ site_name
    ))

# Confirm latitude is complete
any(is.na(arrecifes_sites$latitude)) # Should be FALSE

arrecifes_sites <- arrecifes_sites %>%
  mutate(
    reef_type = if_else(is.na(reef_type), "atoll", reef_type),
    reef_zone = if_else(is.na(reef_zone), "pinnacle", reef_zone),
    reef_exposure = if_else(is.na(reef_exposure), "exposed", reef_exposure)
  )



# 6. VALIDATION SUMMARY
arrecifes %>%
  group_by(site, transect) %>%
  summarise(
    n_quadrats = n_distinct(quadrat),
    avg_points_per_quadrat = n() / n_quadrats,
    .groups = "drop"
  ) %>%
  arrange(site, transect) %>%
  print(n = Inf)


```


### Template MERMAID

```{r}

# 1. DEFINE CONSTANTS
methodology <- "benthic_pqt"
fixed_depth <- 8.34
points_per_quadrat <- 10

# 2. COUNT QUADRATS PER TRANSECT
quadrat_counts <- arrecifes %>%
  group_by(site, transect) %>%
  summarise(`Number of quadrats *` = n_distinct(quadrat), .groups = "drop") %>%
  rename(`Site *` = site, `Transect number *` = transect)

# 3. PREPARE METADATA
mermaid_metadata <- arrecifes %>%
  mutate(
    `Methodology *`         = methodology,
    `Sample date: Year *`   = year(dmy(date)),
    `Sample date: Month *`  = month(dmy(date)),
    `Sample date: Day *`    = day(dmy(date)),
    `Depth *`               = fixed_depth
  ) %>%
  rename(
    `Site *`                = site,
    `Management *`          = management,
    `Transect number *`     = transect,
    `Quadrat *`             = quadrat,
    `Benthic attribute *`   = Label
  )

# 4. APPLY NAME REPLACEMENTS BEFORE GROUPING
coralnet_labels <- read_excel(
  path = here("data", "raw", "Coralnet Labels.xlsx"),
  sheet = "Sheet1"
) %>%
  filter(!is.na(Code), !is.na(Name)) %>%
  distinct(Code, .keep_all = TRUE)

# Force column names to be lowercase (defensive coding)
coralnet_labels <- coralnet_labels %>%
  rename_with(tolower) %>%
  filter(!is.na(code), !is.na(name)) %>%
  distinct(code, .keep_all = TRUE)

# Now perform the merge using lowercase `name`
mermaid_metadata <- mermaid_metadata %>%
  left_join(coralnet_labels, by = c("Benthic attribute *" = "code")) %>%
  mutate(`Benthic attribute *` = coalesce(name, `Benthic attribute *`)) %>%
  select(-name)

mermaid_metadata <- mermaid_metadata %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Dictyota with Sediment"        = "Macroalgae",
    "Sediment"                      = "Sand",
    "Unidentified orange sponge"    = "Sponge",
    "Tube or Rod Sponge"            = "Sponge",
    "Turf with sediment"            = "Turf algae",
    "Unknown Sponge/Tunicate"       = "Sponge",
    "AG"                             = "Agaricia",
    "Gorgonia spp."                 = "Gorgonia",
    "Unknown macroalgae"            = "Macroalgae",
    "Dict"                          = "Silt",
    "Pavement"                      = "Reef pavement",
    "Plexaurella spp."              = "Plexaura",
    "Eunicea spp."                  = "Eunicea",
    "Unidentified Octocoral"        = "Soft coral",
    "Encrusting sponge"             = "Encrusting sponge",
    "Red Macroalgae"                = "Macroalgae",
    "Brown Macroalgae"              = "Macroalgae",
    "Unknown Invertebrate"          = "Other invertebrates",
    "Turf and sand"                 = "Turf algae",
    "Calcareous algae"              = "Macroalgae",
    "Sponge: Cliona"                = "Cliona",
    "Turf growing on hard substrate" = "Turf algae",
    "Sand and sediment"             = "Sand",
    "Mont_spp"                      = "Montastraea spp.",
    "Sponges: Vase"                 = "Sponge"
  )) %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Encrusting sponge"             = "Sponge",
    "Reef pavement"                 = "Bare substrate",
    "Montastraea spp."              = "Montastraea"
  ))%>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Thalassia+ sediement"             = "Thalassia testudinum",
    "Unidentified"                 = "Unknown",
    "Other invertebrate"              = "Other invertebrates",
    "Green Macroalgae"              = "Green algae",
    "Live Coral"              = "Hard coral",
    "sandy mud"              = "Sand"
  )) %>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
    "Sponges: Massive forms: Barrels"            = "Sponge",
    "Turf + Dictyota + Sediment"                 = "Macroalgae",
    "CRED–Turf growing on hard substrate"        = "Turf algae",
    "Macroalgae: Articulated calcareous: green"  = "Macroalgae",
    "Bleached Hard Coral"                        = "Hard coral",
    "Dead coral with algae"                      = "Dead coral",
    "Rope sponge"                                = "Sponge",
    "Erythropodium (encrusting)"                 = "Erythropodium caribaeorum",
    "Green fleshy algae"                         = "Green algae",
    "Porites (massive)"                          = "Porites",
    "Sand / Rubble"                              = "Rubble",
    "Other sessile invertebrates"                = "Other invertebrates",
    "CCA (crustose coralline algae)"             = "Crustose coralline algae",
    "HC_dead"                                    = "Dead coral",
    "Brown fleshy algae"                         = "Macroalgae",
    "Red algae, unidentified encrusting"         = "Crustose red algae",
    "Brain Corals"                               = "Hard coral",
    "Porites (branching)"                        = "Porites",
    "Porites Dead"                               = "Dead coral",
    "Holes"                                      = "Bare substrate",
    "Dead Agaricia"                              = "Agaricia",
    "Cyanobacteria turf sandy"                   = "Cyanobacteria",
    "Macroalgae: Encrusting: red"                = "Crustose red algae",
    "Bleached Agaricia"                          = "Agaricia",
    "CRED-Turf growing on hard substrate"        = "Turf algae"
    ))%>%
  mutate(`Benthic attribute *` = recode(`Benthic attribute *`,
          "Crustose red algae"                        = "Crustose coralline algae"))                                 


# 5. COUNT POINTS PER TRANSECT × QUADRAT × BENTHIC ATTRIBUTE
point_counts <- mermaid_metadata %>%
  group_by(`Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`) %>%
  summarise(`Number of points *` = n(), .groups = "drop")

# 6. JOIN BACK METADATA (one row per group)
mermaid_df <- point_counts %>%
  left_join(
    mermaid_metadata %>% distinct(
      `Site *`, `Transect number *`, `Quadrat *`, `Benthic attribute *`,
      `Methodology *`, `Management *`,
      `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`, `Depth *`
    ),
    by = c("Site *", "Transect number *", "Quadrat *", "Benthic attribute *")
  )

# 7. ADD CONSTANT FIELDS
mermaid_df <- mermaid_df %>%
  mutate(
    `Quadrat size *`              = 1,
    `Transect length surveyed *`  = 50,
    `Number of points per quadrat *` = points_per_quadrat
  ) %>%
  left_join(quadrat_counts, by = c("Site *", "Transect number *"))

# 8. FINAL COLUMN ORDER
selected_arrecifer_habitat_hon <- mermaid_df %>%
  select(
    `Methodology *`, `Site *`, `Management *`,
    `Sample date: Year *`, `Sample date: Month *`, `Sample date: Day *`,
    `Depth *`, `Transect number *`, `Benthic attribute *`,
    `Quadrat size *`, `Transect length surveyed *`, `Quadrat *`,
    `Number of points *`, `Number of points per quadrat *`, `Number of quadrats *`
  )





# 6. EXPORT

# Excel Output:
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_arrecifes_habitat_processed.xlsx")
# write_xlsx(selected_arrecifer_habitat_hon, file_path)



# Export
# folder_path <- here("data", "processed", "honduras", "coralnet")
# file_path <- file.path(folder_path, "hon_coralnet_arrecifes_habitat_sites_processed.xlsx")
# write_xlsx(arrecifes_sites, file_path)



```








